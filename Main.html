<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My first three.js app</title>
</head>
    <body>
        <script src="js/build/three.js"></script>
        <script src="js/src/geometries/ShapeGeometry.js"></script>
        <script src="js/src/geometries/TextGeometry.js"></script>
        <script src="js/examples/js/shaders/UnpackDepthRGBAShader.js"></script>
        <script src="js/examples/js/utils/ShadowMapViewer.js"></script>
        <script src="Planet.js"></script>
            <script>
                var scene = new THREE.Scene();
                var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );
                var renderer = new THREE.WebGLRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.body.appendChild( renderer.domElement );

                var geometry = new THREE.CubeGeometry(100,100,100);
                var material = new THREE.MeshLambertMaterial( {
                    color: 0x00ff00} );
                var cube = new THREE.Mesh( geometry, material );
                cube.position.set(0,0,-500);
                cube.castShadow=true;
                cube.receiveShadow=true;
                //scene.add( cube );

                var spheres=[];

                spheres.push(new Planet(100,30,0,0));
                spheres.push(new Planet(20,5,350,0));

                for(var i=0;i<2;i++){
                    spheres.push(new Planet(Math.random()*50,Math.random()*50,Math.random()*200,Math.random()*200));
                    scene.add(spheres[i].sphere);
                }
                /*var terrain = new THREE.Mesh(new THREE.CubeGeometry(1000,1,1000),new THREE.MeshLambertMaterial({color: 0x00ff00}));
                terrain.position.set(0,-70,-500);
                terrain.castShadow=true;
                terrain.receiveShadow=true;
                scene.add(terrain);*/

                var light = new THREE.AmbientLight(0xffffff,0.5);
                scene.add(light);
                var light2 = new THREE.PointLight(0xffffff,0.5);
                //var light2 = new THREE.SpotLight(0xffffff,0.5,3000);
                light2.target=cube;
                renderer.shadowMap.enabled=true;
                renderer.shadowMap.type = THREE.PCFShadowMap;
                light2.shadow = new THREE.LightShadow(new THREE.PerspectiveCamera(100,1,500,1000));
                light2.shadow.bias=0.0001;
                light2.shadow.mapSize.width=2048*2;
                light2.shadow.mapSize.height=2048*2;
                scene.add(light2);

                var shadowMapViewer = new THREE.ShadowMapViewer(light2);
                shadowMapViewer.position.x=10;
                shadowMapViewer.position.y=10;
                shadowMapViewer.size.width=2048/10;
                shadowMapViewer.size.height=2048/10;
                shadowMapViewer.update();

                var delta =0;
                var render = function () {
                   /* delta+=0.01;
                    camera.lookAt(light.position);
                    camera.position.x=Math.sin(delta)*500;
                    camera.position.z = Math.cos(delta)*500;
                    requestAnimationFrame( render );*/
                    //delta+=0.01; // 0.01
                    var distance = Math.sqrt(Math.pow(spheres[1].sphere.position.x-spheres[0].sphere.position.x, 2) + Math.pow(spheres[1].sphere.position.y-spheres[0].sphere.position.y, 2));
                    delta += Math.pow(distance / 10, -1);
                    /*
                    spheres[1].sphere.position.x = (delta/10) * Math.cos(delta)*150;
                    spheres[1].sphere.position.y = (delta/10) * Math.sin(delta)*150;
                    spheres[0].sphere.position.x = 0;
                    spheres[0].sphere.position.y = 0;
                    */
                    /*
                    spheres[1].sphere.position.x = 450 * Math.cos(delta);
                    spheres[1].sphere.position.y = 150 * Math.sin(delta);
                    */

                    spheres[0].sphere.position.x = 0;
                    spheres[0].sphere.position.y = 0;
                    spheres[0].velocity = [0, 0, 0];
                    spheres[1].applyGravity(spheres[0]);
                    spheres[1].update(spheres[0]);

                    /*
                    spheres[2].sphere.position.x+=1;
                    spheres[2].sphere.position.y+=1;
                    spheres[3].sphere.position.x+=1;
                    spheres[3].sphere.position.y+=1;
                    spheres[4].sphere.position.x+=1;
                    spheres[4].sphere.position.y+=1;
                    for(var i=0;i<spheres.lenght;i++) {
                        spheres[i].sphere.position.x += 1;
                        spheres[i].sphere.position.y += 1;
                    }
                    */
                    requestAnimationFrame(render);
                    renderer.render(scene, camera);
                    shadowMapViewer.render(renderer);
                };

                render();
            </script>
    </body>
</html>