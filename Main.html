<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The simulator of life</title>
</head>
    <body>
        <script src="js/build/three.js"></script>
        <script src="js/src/geometries/ShapeGeometry.js"></script>
        <script src="js/src/geometries/TextGeometry.js"></script>
        <script src="js/examples/js/shaders/UnpackDepthRGBAShader.js"></script>
        <script src="js/examples/js/utils/ShadowMapViewer.js"></script>
        <script src="Planet.js"></script>
            <script>
                //CAMERA, RENDERER AND SCENE
                var scene = new THREE.Scene();
                var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 3000 );
                var renderer = new THREE.WebGLRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.body.appendChild( renderer.domElement );
                camera.position.set(0,0,1700);

                //PLANETS
                var spheres=[];
                spheres.push(new Planet(700,50,0,0)); //down to 10 from 100
                spheres.push(new Planet(10,20,1000,0));
                //spheres.push(new Planet(10, 20, -500, 0));
                spheres.push(new Planet(0.7,5,1558,0));
                //spheres.push(new Planet(0,1,5,360,0));
                spheres[0].sphere.castShadow=false;
                spheres[0].sphere.receiveShadow=false;
                for(var i=0;i<spheres.length;i++){
                    //spheres.push(new Planet(Math.random()*50,Math.random()*50,Math.random()*200,Math.random()*200));
                    scene.add(spheres[i].sphere);
                }

                /*var terrain = new THREE.Mesh(new THREE.CubeGeometry(1000,1,1000),new THREE.MeshLambertMaterial({color: 0x00ff00}));
                terrain.position.set(0,-70,-500);
                terrain.castShadow=true;
                terrain.receiveShadow=true;
                scene.add(terrain);*/

                //LIGHT
                /*var light = new THREE.AmbientLight(0xffffff,0.5);*/
                var sunLight = new THREE.PointLight(0xffffff,3);
                //var ligth = new THREE.SpotLight(0xffffff,0.1);
                //ligth.target=spheres[0].sphere;
                //var light2 = new THREE.SpotLight(0xffffff,0.5,3000);
                sunLight.position.set(0,0,-500);
                renderer.shadowMap.enabled=true;
                renderer.shadowMap.type = THREE.PCFShadowMap;
                sunLight.shadow = new THREE.LightShadow(new THREE.PerspectiveCamera(100,1,500,1000));
                sunLight.shadow.bias=0.0001;
                sunLight.shadow.mapSize.width=2048*2;
                sunLight.shadow.mapSize.height=2048*2;
                scene.add(sunLight);
                //scene.add(ligth);

                //SHADOWS
                var shadowMapViewer = new THREE.ShadowMapViewer(sunLight);
                shadowMapViewer.position.x=10;
                shadowMapViewer.position.y=10;
                shadowMapViewer.size.width=2048/10;
                shadowMapViewer.size.height=2048/10;
                shadowMapViewer.update();

                //SUN GLOW
                spheres[0].sphere.material=new THREE.MeshBasicMaterial( {color: 0xffd700} );
                var spriteMaterial = new THREE.SpriteMaterial(
                    {
                        map: new THREE.ImageUtils.loadTexture( 'images/glow.png' ),
                        color: 0xffd700, transparent: false, blending: THREE.AdditiveBlending
                    });
                var sprite = new THREE.Sprite( spriteMaterial );
                sprite.scale.set(200, 200, 1.0);
                spheres[0].sphere.add(sprite);

                var delta =0;
                var render = function () {
                   /* delta+=0.01;
                    camera.lookAt(light.position);
                    camera.position.x=Math.sin(delta)*500;
                    camera.position.z = Math.cos(delta)*500;
                    requestAnimationFrame( render );*/
                    //delta+=0.01; // 0.01
                    //var distance = Math.sqrt(Math.pow(spheres[1].sphere.position.x-spheres[0].sphere.position.x, 2) + Math.pow(spheres[1].sphere.position.y-spheres[0].sphere.position.y, 2));
                    //delta += Math.pow(distance / 10, -1);
                    /*
                    spheres[1].sphere.position.x = (delta/10) * Math.cos(delta)*150;
                    spheres[1].sphere.position.y = (delta/10) * Math.sin(delta)*150;
                    spheres[0].sphere.position.x = 0;
                    spheres[0].sphere.position.y = 0;
                    */
                    /*
                    spheres[1].sphere.position.x = 450 * Math.cos(delta);
                    spheres[1].sphere.position.y = 150 * Math.sin(delta);
                    */

                    spheres[0].sphere.position.x = 0;
                    spheres[0].sphere.position.y = 0;
                    spheres[0].velocity = [0, 0, 0];
                    for(var i=1;i<spheres.length;i++){
                        spheres[i].applyGravity(spheres,i);
                        spheres[i].update();
                    }

                    /*
                    spheres[2].sphere.position.x+=1;
                    spheres[2].sphere.position.y+=1;
                    spheres[3].sphere.position.x+=1;
                    spheres[3].sphere.position.y+=1;
                    spheres[4].sphere.position.x+=1;
                    spheres[4].sphere.position.y+=1;
                    for(var i=0;i<spheres.lenght;i++) {
                        spheres[i].sphere.position.x += 1;
                        spheres[i].sphere.position.y += 1;
                    }
                    */
                    requestAnimationFrame(render);
                    renderer.render(scene, camera);
                    shadowMapViewer.render(renderer);
                };

                render();
            </script>
    </body>
</html>